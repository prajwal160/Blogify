<!DOCTYPE html>
<html lang="en">
<head>
    <%- include("./partials/head.ejs") %>
    <title><%= locals.pageTitle || "Blogify" %></title>
</head>
<body>
    <%- include("./partials/nav.ejs") %>

    <main class="page-wrap home-shell">
        <section class="surface-card home-hero">
            <h1 class="hero-title">Read sharp stories from curious builders.</h1>
            <p class="hero-subtitle">
                Search, filter, and discover fresh ideas from the Blogify community.
            </p>

            <form class="hero-tools" method="get" action="/">
                <input
                    class="hero-search"
                    type="text"
                    name="q"
                    value="<%= filters?.q || '' %>"
                    placeholder="Search by title, excerpt, or tag"
                >
                <select class="hero-select" name="sort">
                    <option value="latest" <%= (filters?.sort || 'latest') === 'latest' ? 'selected' : '' %>>Latest</option>
                    <option value="oldest" <%= filters?.sort === 'oldest' ? 'selected' : '' %>>Oldest</option>
                    <option value="popular" <%= filters?.sort === 'popular' ? 'selected' : '' %>>Popular</option>
                </select>
                <% if (filters?.tag) { %>
                    <input type="hidden" name="tag" value="<%= filters.tag %>">
                <% } %>
                <button class="btn btn-primary pill-btn" type="submit">Search</button>
                <% if (filters?.q || filters?.tag || (filters?.sort && filters.sort !== 'latest')) { %>
                    <a class="btn btn-outline-secondary pill-btn" href="/">Reset</a>
                <% } %>
            </form>

            <% if (topTags && topTags.length) { %>
                <div class="tag-strip">
                    <% topTags.forEach((tagName) => { %>
                        <a
                            href="/?tag=<%= encodeURIComponent(tagName) %>&sort=<%= encodeURIComponent(filters?.sort || 'latest') %>"
                            class="hero-chip <%= filters?.tag === tagName ? 'hero-chip-active' : '' %>"
                        >
                            #<%= tagName %>
                        </a>
                    <% }) %>
                </div>
            <% } %>
        </section>

        <% if (blogs && blogs.length > 0) { %>
            <section class="blog-grid">
                <% blogs.forEach((blog) => { %>
                    <% const canEdit = !!locals.user; %>
                    <% const canDelete = locals.user && blog.createdBy && String(locals.user._id) === String(blog.createdBy._id); %>
                    <% const returnTo = '/?q=' + encodeURIComponent(filters?.q || '') + '&tag=' + encodeURIComponent(filters?.tag || '') + '&sort=' + encodeURIComponent(filters?.sort || 'latest') + '&page=' + encodeURIComponent(filters?.page || 1) + '#blog-' + blog._id; %>
                    <article class="blog-grid-item" id="blog-<%= blog._id %>">
                        <div class="surface-card blog-card">
                            <div class="blog-card-cover-wrap">
                                <img
                                    class="blog-card-cover"
                                    src="<%= blog.coverImageURL ? blog.coverImageURL : '/uploads/1739908497311-garg4.png' %>"
                                    alt="<%= blog.title %>"
                                >
                                <% if (canEdit) { %>
                                    <div class="dropdown card-cover-menu">
                                        <button
                                            class="btn btn-sm card-menu-btn"
                                            type="button"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false"
                                            aria-label="Post actions"
                                        >
                                            &#8942;
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <a class="dropdown-item" href="/blog/<%= blog.slug || blog._id %>/edit?returnTo=<%= encodeURIComponent(returnTo) %>">Edit Post</a>
                                            </li>
                                            <% if (canDelete) { %>
                                                <li>
                                                    <form action="/blog/<%= blog.slug || blog._id %>/delete" method="post" onsubmit="return confirm('Delete this blog permanently?')">
                                                        <button class="dropdown-item text-danger" type="submit">Delete Post</button>
                                                    </form>
                                                </li>
                                            <% } %>
                                        </ul>
                                    </div>
                                <% } %>
                            </div>

                            <div class="blog-card-body">
                                <h2 class="blog-card-title"><%= blog.title %></h2>
                                <p class="blog-meta">
                                    <%= blog.createdBy?.fullName || 'Unknown Author' %> |
                                    <%= new Date(blog.createdAt).toLocaleDateString() %> |
                                    <%= blog.views || 0 %> views
                                </p>
                                <% if (blog.excerpt) { %>
                                    <p class="blog-excerpt"><%= blog.excerpt %></p>
                                <% } %>
                                <a href="/blog/<%= blog.slug || blog._id %>" class="btn btn-sm btn-primary pill-btn">Read Post</a>
                            </div>
                        </div>
                    </article>
                <% }) %>
            </section>

            <section class="pagination-wrap">
                <div class="text-muted small">
                    Showing page <%= pagination.currentPage %> of <%= pagination.totalPages %> (<%= pagination.totalBlogs %> posts)
                </div>
                <div class="d-flex gap-2">
                    <% if (pagination.hasPrev) { %>
                        <a class="btn btn-outline-secondary btn-sm pill-btn" href="/?q=<%= encodeURIComponent(filters?.q || '') %>&tag=<%= encodeURIComponent(filters?.tag || '') %>&sort=<%= encodeURIComponent(filters?.sort || 'latest') %>&page=<%= pagination.currentPage - 1 %>">Previous</a>
                    <% } %>
                    <% if (pagination.hasNext) { %>
                        <a class="btn btn-outline-secondary btn-sm pill-btn" href="/?q=<%= encodeURIComponent(filters?.q || '') %>&tag=<%= encodeURIComponent(filters?.tag || '') %>&sort=<%= encodeURIComponent(filters?.sort || 'latest') %>&page=<%= pagination.currentPage + 1 %>">Next</a>
                    <% } %>
                </div>
            </section>
        <% } else { %>
            <section class="surface-card empty-state">
                <h2>No matching posts</h2>
                <p>Try another search term, tag, or sort option.</p>
                <a href="/" class="btn btn-primary pill-btn">Clear Filters</a>
            </section>
        <% } %>
    </main>
    <%- include("./partials/footer.ejs") %>

    <%- include("./partials/scripts.ejs") %>
</body>
</html>
