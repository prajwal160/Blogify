<!DOCTYPE html>
<html lang="en">
<head>
    <%- include("./partials/head.ejs") %>
    <title><%= locals.pageTitle || (blog.title + " | Blogify") %></title>
</head>
<body>
    <%- include("./partials/nav.ejs") %>

    <main class="page-wrap blog-shell">
        <section class="surface-card blog-header">
            <h1 class="blog-title"><%= blog.title %></h1>
            <p class="blog-byline">
                <%= blog.createdBy?.fullName || "Unknown Author" %> •
                <%= new Date(blog.createdAt).toLocaleDateString() %> •
                <%= blog.views || 0 %> views •
                <%= blog.likesCount || 0 %> likes
            </p>

            <% if (locals.user) { %>
                <div class="blog-actions mt-3">
                    <form action="/blog/<%= blog.slug || blog._id %>/like" method="post">
                        <button class="btn btn-sm <%= isLiked ? 'btn-outline-danger' : 'btn-outline-primary' %> pill-btn" type="submit">
                            <%= isLiked ? 'Unlike' : 'Like' %>
                        </button>
                    </form>
                    <form action="/blog/<%= blog.slug || blog._id %>/bookmark" method="post">
                        <button class="btn btn-sm <%= isBookmarked ? 'btn-outline-success' : 'btn-outline-secondary' %> pill-btn" type="submit">
                            <%= isBookmarked ? 'Bookmarked' : 'Bookmark' %>
                        </button>
                    </form>
                    <% if (isOwner) { %>
                        <a class="btn btn-sm btn-outline-dark pill-btn" href="/blog/<%= blog.slug || blog._id %>/edit">Edit</a>
                        <form action="/blog/<%= blog.slug || blog._id %>/delete" method="post" onsubmit="return confirm('Delete this blog permanently?')">
                            <button class="btn btn-sm btn-outline-danger pill-btn" type="submit">Delete</button>
                        </form>
                    <% } %>
                </div>
            <% } %>
        </section>

        <section class="surface-card blog-cover-wrap">
            <img
                class="blog-cover"
                src="<%= blog.coverImageURL || '/images/default.png' %>"
                alt="<%= blog.title %>"
            >
        </section>

        <section class="surface-card blog-content">
            <p class="blog-content-text"><%= blog.body %></p>
        </section>

        <section class="surface-card author-card">
            <img src="<%= blog.createdBy?.profileImageURL || '/images/default.png' %>" alt="Author avatar">
            <div>
                <strong><%= blog.createdBy?.fullName || "Unknown Author" %></strong>
                <div class="text-muted small">Author</div>
            </div>
        </section>

        <section class="surface-card comments-card">
            <h2 class="comments-title">Comments (<%= comments.length %>)</h2>

            <% if (locals.user) { %>
                <form action="/blog/comment/<%= blog.id %>" method="post">
                    <div class="mb-2">
                        <input
                            type="text"
                            class="form-control"
                            name="content"
                            placeholder="Write a comment..."
                        />
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm pill-btn">Post Comment</button>
                </form>
            <% } else { %>
                <p class="text-muted mb-2">
                    <a href="/user/signin">Signin</a> to post a comment.
                </p>
            <% } %>

            <% if (comments.length > 0) { %>
                <div class="comment-list">
                    <% comments.forEach((comment) => { %>
                        <article class="comment-item">
                            <div class="comment-meta">
                                <img src="<%= comment.createdBy?.profileImageURL || '/images/default.png' %>" alt="Comment author">
                                <span><%= comment.createdBy?.fullName || "User" %></span>
                            </div>
                            <p class="comment-text"><%= comment.content %></p>
                        </article>
                    <% }) %>
                </div>
            <% } %>
        </section>

        <% if (relatedBlogs && relatedBlogs.length > 0) { %>
            <section class="surface-card related-card">
                <h3 class="mb-3">Related Posts</h3>
                <div class="related-grid">
                    <% relatedBlogs.forEach((item) => { %>
                        <a class="related-item" href="/blog/<%= item.slug || item._id %>">
                            <img src="<%= item.coverImageURL || '/images/default.png' %>" alt="<%= item.title %>">
                            <div>
                                <strong><%= item.title %></strong>
                                <div class="text-muted small"><%= new Date(item.createdAt).toLocaleDateString() %></div>
                            </div>
                        </a>
                    <% }) %>
                </div>
            </section>
        <% } %>
    </main>

    <%- include("./partials/scripts.ejs") %>
</body>
</html>
